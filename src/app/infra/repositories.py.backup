# src/app/infra/repositories.py
import os
import git
from typing import List, Optional, Dict
from src.app.domain.modeles import Oeuvre, Utilisateur

class FileSystemGitRepository:
    def __init__(self, root_dir: str):
        self.root_dir = root_dir
        
        # Initialisation du dépôt Git
        try:
            self.repo = git.Repo(self.root_dir)
        except git.exc.InvalidGitRepositoryError:
            print(f"[Infra] Init Git dans {self.root_dir}")
            self.repo = git.Repo.init(self.root_dir)

    def _get_path(self, dossier: str, filename: str) -> str:
        return os.path.join(self.root_dir, "data", dossier, filename)

    def _ensure_dir(self, dossier: str):
        os.makedirs(os.path.join(self.root_dir, "data", dossier), exist_ok=True)

    # --- Gestion du format Markdown + Frontmatter ---

    def _serialize_to_markdown(self, oeuvre: Oeuvre) -> str:
        def safe(val): return str(val).replace('"', '\\"')

        #md = "---\n"
        md = f'titre: "{safe(oeuvre.titre)}"\n'
        md += f'auteur: "{safe(oeuvre.auteur)}"\n'
        md += f'fichier: "{safe(oeuvre.fichier_nom)}"\n'
        md += f'soumis_par: "{safe(oeuvre.soumis_par_email)}"\n'
        md += f'date: "{safe(oeuvre.date_soumission)}"\n'
        md += f'etat: "{safe(oeuvre.etat.nom)}"\n'
        
        for k, v in oeuvre.metadonnees.items():
            md += f'{k}: "{safe(v)}"\n'
            
        #md += "---\n\n"
        
        return md

    def _parse_from_markdown(self, content: str) -> Dict:
        data = {}
        lines = content.split('\n')
        if lines[0].strip() == "---":
            for line in lines[1:]:
                if line.strip() == "---":
                    break
                if ":" in line:
                    key, val = line.split(":", 1)
                    data[key.strip()] = val.strip().strip('"')
        return data

    # --- Méthodes du Repository ---

    def sauvegarder_emprunt(self, emprunt):
        """
        Sauvegarde un emprunt dans Git
        
        Args:
            emprunt: Instance de Emprunt
        """
        # Création d'un fichier JSON pour l'emprunt
        import json
        
        emprunt_dir = os.path.join(self.root_dir, "data", "emprunts")
        os.makedirs(emprunt_dir, exist_ok=True)
        
        emprunt_file = os.path.join(emprunt_dir, f"{emprunt.id}.json")
        
        emprunt_data = {
            "id": emprunt.id,
            "oeuvre_id": emprunt.oeuvre_id,
            "oeuvre_titre": emprunt.oeuvre_titre,
            "utilisateur_email": emprunt.utilisateur_email,
            "date_debut": emprunt.date_debut.isoformat(),
            "date_fin": emprunt.date_fin.isoformat(),
            "est_actif": emprunt.est_actif
        }
        
        with open(emprunt_file, 'w', encoding='utf-8') as f:
            json.dump(emprunt_data, f, indent=2)
        
        # Commit Git
        self.repo.index.add([emprunt_file])
        self.repo.index.commit(f"Emprunt: {emprunt.oeuvre_titre} par {emprunt.utilisateur_email}")
        
        print(f"[Git] Emprunt sauvegardé : {emprunt.id}")

    def lister_oeuvres_en_attente(self) -> List[Oeuvre]:
        oeuvres = []
        path = os.path.join(self.root_dir, "data", "a_moderer")
        
        if not os.path.exists(path): return []

        for filename in os.listdir(path):
            if filename.endswith(".md"):
                try:
                    with open(os.path.join(path, filename), 'r', encoding='utf-8') as f:
                        data = self._parse_from_markdown(f.read())
                        
                        # --- CORRECTION ICI ---
                        # On fournit tous les champs obligatoires (nom, prenom, email, mdp)
                        user_stub = Utilisateur(
                            nom="Inconnu", 
                            prenom="", 
                            email=data.get("soumis_par", "inconnu"), 
                            mdp=""
                        )
                        
                        o = Oeuvre(
                            titre=data.get("titre", "Sans titre"),
                            auteur=data.get("auteur", "Inconnu"),
                            fichier_nom=data.get("fichier", ""),
                            soumis_par=user_stub
                        )
                        oeuvres.append(o)
                except Exception as e:
                    print(f"Erreur lecture {filename}: {e}")
        return oeuvres

    def get_oeuvre_by_id(self, id_oeuvre: str) -> Optional[Oeuvre]:
        for dossier in ["a_moderer", "fond_commun", "sequestre"]:
            path = self._get_path(dossier, id_oeuvre)
            if os.path.exists(path):
                with open(path, 'r', encoding='utf-8') as f:
                    data = self._parse_from_markdown(f.read())
                    
                    # --- CORRECTION ICI AUSSI ---
                    user_stub = Utilisateur(
                        nom="Inconnu", 
                        prenom="", 
                        email=data.get("soumis_par"), 
                        mdp=""
                    )
                    
                    o = Oeuvre(data.get("titre"), data.get("auteur"), data.get("fichier"), user_stub)
                    
                    etat_str = data.get("etat")
                    if etat_str == "EN_TRAITEMENT":
                        o.traiter()
                    elif etat_str == "VALIDEE":
                        o.valider()
                    
                    return o
        return None

    def deplacer_vers_catalogue(self, oeuvre: Oeuvre, destination: str):
        filename = f"{oeuvre.titre.replace(' ', '_')}.md"
        old_path = self._get_path("a_moderer", filename)
        new_path = self._get_path(destination, filename)
        self._ensure_dir(destination)

        if os.path.exists(old_path):
            os.rename(old_path, new_path)
            
            content = self._serialize_to_markdown(oeuvre)
            with open(new_path, 'w', encoding='utf-8') as f:
                f.write(content)

            self.repo.index.remove([old_path])
            self.repo.index.add([new_path])
            self.repo.index.commit(f"Publication: {oeuvre.titre}")